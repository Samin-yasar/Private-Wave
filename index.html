<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure P2P Chat</title>
  <meta name="theme-color" content="#121212" />
  <link rel="manifest" href="/Private-Wave/manifest.json">
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: #e0e0e0;
      padding: 2rem;
    }
    #chat {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 1rem;
      max-width: 600px;
      margin: auto;
    }
    #messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #2c2c2c;
    }
    .msg {
      margin: 0.5rem 0;
    }
    .msg.me {
      text-align: right;
      color: #90caf9;
    }
    .nickname {
      font-weight: bold;
      display: block;
    }
    .timestamp {
      font-size: 0.75rem;
      color: #999;
    }
    #media-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 0.5rem;
    }
    input, button, textarea {
      padding: 0.5rem;
      border-radius: 0.5rem;
      background: #333;
      color: white;
      border: 1px solid #555;
    }
    textarea {
      width: 100%;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="chat">
    <h2>Secure P2P Chat</h2>
    <div><strong>Nickname:</strong> <span id="myNick"></span></div>
    <div id="messages"></div>
    <input type="file" id="fileInput" />
    <br><br>
    <input type="text" id="message" placeholder="Type your message..." style="width: 70%;" />
    <button onclick="sendMessage()">Send</button>
    <h4>Signal Exchange</h4>
    <textarea id="mySignal" readonly></textarea>
    <button onclick="copySignal()">Copy My Signal</button>
  </div>

  <script src="https://unpkg.com/simple-peer@9/simplepeer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl-util/0.15.1/nacl-util.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const peer = new SimplePeer({ initiator: location.hash === '#init', trickle: false });
    let theirPublicKey;
    const myKeyPair = nacl.box.keyPair();
    const encoder = nacl.util;

    const myNickname = prompt("Enter your nickname:");
    document.getElementById("myNick").textContent = myNickname || "Me";

    peer.on('signal', data => {
      const signalText = JSON.stringify(data);
      document.getElementById('mySignal').value = signalText;
    });

    peer.on('connect', () => {
      alert('Secure connection established!');
    });

    peer.on('data', data => {
      const decrypted = decryptMessage(data);
      if (decrypted.type === 'text') {
        addMessage(decrypted.message, false, decrypted.nickname);
      } else if (decrypted.type === 'media') {
        const blob = new Blob([new Uint8Array(decrypted.buffer)], { type: decrypted.mime });
        const url = URL.createObjectURL(blob);
        if (decrypted.mime.startsWith('image')) {
          const img = document.createElement('img');
          img.src = url;
          img.style.maxWidth = '100%';
          img.style.maxHeight = '200px';
          addMessage(img, false, decrypted.nickname);
        } else if (decrypted.mime.startsWith('video')) {
          const video = document.createElement('video');
          video.src = url;
          video.controls = true;
          video.style.maxWidth = '100%';
          video.style.maxHeight = '200px';
          addMessage(video, false, decrypted.nickname);
        }
      }
    });

    function addMessage(content, isOwnMessage, nickname) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('msg');
      if (isOwnMessage) {
        messageDiv.classList.add('me');
      }
      const nicknameElem = document.createElement('span');
      nicknameElem.classList.add('nickname');
      nicknameElem.textContent = nickname || "Anonymous";
      messageDiv.appendChild(nicknameElem);

      const timestampElem = document.createElement('span');
      timestampElem.classList.add('timestamp');
      timestampElem.textContent = new Date().toLocaleTimeString();
      messageDiv.appendChild(timestampElem);

      if (typeof content === 'string') {
        messageDiv.appendChild(document.createTextNode(content));
      } else {
        messageDiv.appendChild(content);
      }

      document.getElementById('messages').appendChild(messageDiv);
      const messagesContainer = document.getElementById('messages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function encryptMessage(message) {
      const nonce = nacl.randomBytes(nacl.box.nonceLength);
      const encrypted = nacl.box(encoder.decodeUTF8(message), nonce, theirPublicKey, myKeyPair.secretKey);
      return { encryptedMessage: encrypted, nonce: nonce };
    }

    function decryptMessage(data) {
      const decrypted = nacl.box.open(data.encryptedMessage, data.nonce, myKeyPair.publicKey, theirPublicKey);
      return { message: encoder.encodeUTF8(decrypted), type: data.type, nickname: data.nickname };
    }

    function sendMessage() {
      const messageInput = document.getElementById("message");
      const message = messageInput.value.trim();
      if (message.length > 0) {
        const encrypted = encryptMessage(message);
        peer.send(JSON.stringify({ encryptedMessage: encrypted.encryptedMessage, nonce: encrypted.nonce, type: 'text', nickname: myNickname }));
        addMessage(message, true, myNickname);
        messageInput.value = '';
      }
    }

    document.getElementById("fileInput").addEventListener('change', event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function() {
          const buffer = reader.result;
          const encryptedFile = encryptMessage(buffer);
          peer.send(JSON.stringify({ encryptedMessage: encryptedFile.encryptedMessage, nonce: encryptedFile.nonce, type: 'media', mime: file.type, buffer: buffer, nickname: myNickname }));
        };
        reader.readAsArrayBuffer(file);
      }
    });

    function copySignal() {
      const signalText = document.getElementById('mySignal').value;
      navigator.clipboard.writeText(signalText).then(() => alert('Signal copied to clipboard!'));
    }
  </script>
</body>
</html>
